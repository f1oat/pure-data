name: pd-ceammc
version: "@CEAMMC_DISTRIB_VERSION@"
license: "GPL-3.0"
summary: "Pure Data CEAMMC distribution"
description: |
    Pure Data CEAMMC distribution and library of externals used for work and education purposes in Centre of electoacoustic music of Moscow Conservatory (CEAMMC) and ZIL-electro studio.

confinement: devmode
base: core18
icon: ceammc/gui/icons/puredata-ceammc.png

architectures:
    - amd64
    - i386
    - armhf
    - arm64
    - s390x

environment:
    TCL8.6_TM_PATH: ${SNAP}/usr/share/tcltk/tcl8.6/tcl8
    TCL_LIBRARY: ${SNAP}/usr/share/tcltk/tcl8.6
    TK_LIBRARY:  "${SNAP}/usr/share/tcltk/tk8.6 ${SNAP}/usr/lib/x86_64-linux-gnu ${SNAP}/usr/lib/tcltk/x86_64-linux-gnu"

layout:
    /usr/lib/$SNAPCRAFT_ARCH_TRIPLET/alsa-lib:
        bind: $SNAP/usr/lib/$SNAPCRAFT_ARCH_TRIPLET/alsa-lib
    /etc/asound.conf:
        bind-file: $SNAP/etc/alsa.conf
    /usr/share/alsa/alsa.conf:
        bind-file: $SNAP/usr/share/alsa/alsa.conf

apps:
    pd-ceammc:
        command: usr/bin/pd.wrapper
        desktop: share/applications/pd-ceammc.desktop
        plugs:
            - pulseaudio
            - home
            - unity7
            - x11
            - network
            - desktop
            - desktop-legacy
    tclsh:
        command: usr/bin/tclsh.wrapper
        plugs: [ home, x11, network, desktop, desktop-legacy ]
    wish:
        command: usr/bin/wish.wrapper
        plugs: [ home, x11, network, desktop, desktop-legacy ]
    pdsend:
        command: lib/pd_ceammc/bin/pdsend
        plugs: [ network ]
    pdreceive:
        command: lib/pd_ceammc/bin/pdreceive
        plugs: [ network ]

parts:
    fix-hardcoded:
        plugin: nil
        after: [ wrappers ]
        override-build: |
            #find ${SNAPCRAFT_PRIME}/../parts/pd-ceammc -name pkgIndex.tcl
            fsname="/usr/lib/tcltk/x86_64-linux-gnu/tk8.6/pkgIndex.tcl"
            file="${SNAPCRAFT_PRIME}/../parts/pd-ceammc/install${fsname}"
            sed -i "s|file join /usr/lib/x86_64-linux-gnu libtk8.6.so|file join {} libtk8.6.so|" $file
            find ${SNAPCRAFT_STAGE}/usr/lib -name pkgIndex.tcl
            file="${SNAPCRAFT_STAGE}/${fsname}"
            sed -i "s|file join /usr/lib/x86_64-linux-gnu libtk8.6.so|file join {} libtk8.6.so|" $file
    wrappers:
        plugin: dump
        after: [ pd-ceammc ]
        source: ceammc/distrib/linux/snap
        organize:
            pd.wrapper: /usr/bin/pd.wrapper
            tclsh.wrapper: /usr/bin/tclsh.wrapper
            wish.wrapper: /usr/bin/wish.wrapper

    alsa:
        plugin: nil
        source: https://github.com/diddledan/snapcraft-alsa.git
        override-pull: |
            cat > alsa.conf <<EOF
            pcm.!default {
            type pulse
            fallback "sysdefault"
            hint {
                show on
                description "Default ALSA Output (currently PulseAudio Sound Server)"
            }
            }
            ctl.!default {
            type pulse
            fallback "sysdefault"
            }
            EOF
        override-build: |
            install -m644 -D -t $SNAPCRAFT_PART_INSTALL/etc alsa.conf
        stage-packages:
            - libasound2
            - libasound2-plugins

    pd-ceammc:
        plugin: cmake
        configflags:
            - -DWITH_PORTAUDIO=OFF
            - -DWITH_BENCHMARK=OFF
            - -DENABLE_TESTS=OFF
            - -DCMAKE_BUILD_TYPE=Debug
        source: .
        build-packages:
            - g++
            - make
            - cmake
            - pkg-config
            - libasound2-dev
            - libmodplug-dev
            - libboost-dev
            - gettext
            - libavahi-compat-libdnssd-dev
            - libsndfile1-dev
            - libjack-jackd2-dev
            - libfftw3-dev
            - tcllib
            - tklib
            - alsa-utils
            - build-essential
            - patchelf
            - libarmadillo-dev
            - libglib2.0-dev
            - libxcb-randr0-dev
            - libxcb-util-dev
            - libxcb1-dev
            - x11proto-dev
            - lsb-release
        stage-packages:
            - libsndfile1
            - libfftw3-single3
            - libmodplug1
            - libasound2
            - tcl
            - tk
            - libtcl8.6
            - tklib
            - tcllib
            - libatm1
            - libxtables12
            - libxcb-randr0
            - libjack-jackd2-0
            - libice6
